<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>修改密码 - 知识共享平台</title>
        <link rel="stylesheet" href="styles.css">
        <script>
            // 按其它页面约定应用已保存的主题（light/dark）
            try { var t = localStorage.getItem('theme'); if (t) { document.documentElement.setAttribute('data-theme', JSON.parse(t)); } } catch {}
        </script>
    <style>
            .container { max-width: 520px; margin: 50px auto; padding: 0 16px; }
            .form-title { margin: 0 0 8px 0; }
            #message { text-align: center; margin-top: 14px; font-weight: bold; }
            /* 对齐输入白块：复用全站 .field 样式，确保 3 个输入等宽对齐 */
            .field span { font-size: 14px; color: var(--muted); }
            .actions { display: grid; gap: 10px; margin-top: 6px; }
    </style>
</head>
<body>
        <!-- 背景层与磨砂玻璃卡片，视觉与其它页面一致 -->
        <div class="bg-grad"></div>
        <div class="bg-noise"></div>
        <main class="container">
            <div class="card glass" style="padding: 24px;">
                <h2 class="form-title" style="margin: 10px">修改密码</h2>
                <p class="muted" style="margin: 10px">为了您的账户安全，请定期修改密码。</p>
                <form id="change-password-form" novalidate style="margin: 10px">
                    <label class="field">
                        <span>当前密码</span>
                        <input type="password" id="oldPassword" name="oldPassword" required autocomplete="current-password" />
                    </label>
                    <label class="field">
                        <span>新密码</span>
                        <input type="password" id="newPassword" name="newPassword" minlength="6" required autocomplete="new-password" />
                    </label>
                    <label class="field">
                        <span>确认新密码</span>
                        <input type="password" id="confirmPassword" name="confirmPassword" required autocomplete="new-password" />
                    </label>
                    <div class="actions" style="margin: 10px">
                        <button type="submit" class="btn primary full">确认修改</button>
                    </div>
                </form>
                <div id="message"></div>
            </div>
        </main>

    <!-- 先覆盖 API 基础地址，再加载 api-client.js -->
    <script>
        // 关键改动：直接硬编码 API 地址，确保在 api-client.js 加载前生效
        window.API_BASE_URL = 'http://<公网IP>/api';
    </script>
    <script src="api-client.js"></script>
    <script>
        const form = document.getElementById('change-password-form');
        const messageDiv = document.getElementById('message');

        // 关键改动：已移除所有 DOMContentLoaded 和页面加载时的登录检查逻辑。
        // 页面本身不再执行任何自动跳转。

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            messageDiv.textContent = '';
            messageDiv.className = '';

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                messageDiv.textContent = '两次输入的新密码不一致！';
                messageDiv.classList.add('error');
                return;
            }

            try {
                // api-client.js 会自动从 localStorage 读取 authToken 并加入请求头
                const result = await api.changePassword(oldPassword, newPassword);
                
                if (result.success) {
                    messageDiv.textContent = '密码修改成功！2秒后将跳转到登录页。';
                    messageDiv.classList.add('success');
                    
                    // 完全清理登录凭证
                    api.logout(); 
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('authUser');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');

                    setTimeout(() => {
                        // 使用绝对路径跳转
                        window.location.href = '/index.html';
                    }, 2000);
                } else {
                    throw new Error(result.message || '密码修改失败');
                }
            } catch (error) {
                const errorMessage = String(error.message || '发生未知错误');
                // 如果是认证错误，给出明确指引
                if (errorMessage.includes('401') || errorMessage.toLowerCase().includes('unauthorized')) {
                    messageDiv.textContent = '认证失败，请重新登录后再试。';
                } else {
                    messageDiv.textContent = errorMessage;
                }
                messageDiv.classList.add('error');
            }
        });
    </script>
</body>
</html>
